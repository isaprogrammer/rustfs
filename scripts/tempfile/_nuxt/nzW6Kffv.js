import{_ as H}from"./C-3P3SYp.js";import{e as te,i as ae,k as ne,r as k,A as ie,m as F,o as N,n as e,w as i,b as s,a as C,d as x,t as p,C as q,c as J,y as X,F as Y,_ as V,p as z,K as oe,B as le,L as y}from"./BvexhTZs.js";import G from"./B2MUHF3Z.js";import{_ as re}from"./DvIOyMed.js";import{_ as ue}from"./DLtCItMV.js";import{_ as ce,a as fe,b as de,c as me}from"./DNxf501w.js";import{_ as pe,u as ve,D as _e}from"./BQKrPI31.js";import{_ as Z}from"./Te087XyE.js";import{_ as j,a as O,b as I}from"./CX0wwNc8.js";import{_ as ee}from"./QhSbJoSr.js";import{_ as be,a as ge,b as xe,c as ye,d as Ce}from"./CIcvgKWt.js";import{_ as he}from"./6l0Pl64a.js";import{u as Ne}from"./C0Cf6JZT.js";import{u as se}from"./DirN9_Lc.js";import{_ as Ee}from"./BmVW1-Kl.js";import"./CjRf5-Eg.js";import"./CNS46M7W.js";import"./BDEBxj3U.js";import"./DlAUqK2U.js";import"./CzQd9PUz.js";import"./CHIgUVhi.js";import"./Baq5sz8T.js";import"./DW7TBzO-.js";import"./DUVp9UZ0.js";import"./CUw6zPDB.js";import"./CLsMh9cr.js";import"./k0-rRQS5.js";import"./BaE5Zpvg.js";import"./BAYMBq5_.js";import"./CtKdyHjI.js";const ke={class:"block text-sm font-normal text-muted-foreground"},Re={class:"space-y-6"},Se={class:"flex flex-col gap-2 p-4"},Fe={class:"flex flex-col gap-2 pt-6 sm:flex-row sm:justify-center"},Te=te({__name:"new-form",props:{bucketName:{}},emits:["success"],setup(Q,{expose:u,emit:A}){const{getEventTargetArnList:B}=Ne(),{putBucketNotifications:U,listBucketNotifications:P}=se({}),{t:c}=ae(),T=ne(),$=Q,_=A,v=k(!1),l=k({resourceName:"",prefix:"",suffix:"",events:[]}),b=ie({resourceName:"",events:""}),M=[{value:"PUT",labelKey:"PUT - Object upload"},{value:"GET",labelKey:"GET - Object access"},{value:"DELETE",labelKey:"DELETE - Object deletion"},{value:"REPLICA",labelKey:"REPLICA - Object migration"},{value:"RESTORE",labelKey:"ILM - Object converted"},{value:"SCANNER",labelKey:"SCANNER - Object has too many versions/prefix has too many subfolders"}],L=k([]);B().then(n=>{L.value=n.map(t=>({label:t,value:t}))});const D=()=>{v.value=!0},W=n=>{v.value=n,n||w()},w=()=>{l.value={resourceName:"",prefix:"",suffix:"",events:[]},b.resourceName="",b.events=""},R=(n,t)=>{const o=t===!0||t==="indeterminate";o&&!l.value.events.includes(n)?l.value.events.push(n):o||(l.value.events=l.value.events.filter(m=>m!==n))},a=(n,t)=>{R(n,t)},f=()=>(b.resourceName=l.value.resourceName?"":c("Please select resource name"),b.events=l.value.events.length?"":c("Please select at least one event"),!b.resourceName&&!b.events),r=async()=>{if(f())try{const n={PUT:["s3:0bjectCreated:*"],GET:["s3:0bjectAccessed:*"],DELETE:["s3:0bjectRemoved:*"],REPLICA:["s3:Replication:*"],RESTORE:["s3:ObjectRestore:*","s3:0bjectTransition:*"],SCANNER:["s3:Scanner:ManyVersions","s3:Scanner:BigPrefix"]},t=[];l.value.events.forEach(S=>{n[S]?t.push(...n[S]):t.push(S)});const o=[...new Set(t)];if(!o.length){T.error(c("No valid events found after conversion"));return}let m={};try{m=await P($.bucketName)||{}}catch(S){console.warn("Failed to get current notification config, will use empty config:",S),m={}}const E=l.value.resourceName,g={},h={Id:`notification-${Date.now()}`,Events:o,Filter:{Key:{FilterRules:[]}}};l.value.prefix&&h.Filter.Key.FilterRules.push({Name:"Prefix",Value:l.value.prefix}),l.value.suffix&&h.Filter.Key.FilterRules.push({Name:"Suffix",Value:l.value.suffix}),h.Filter.Key.FilterRules.length||delete h.Filter,E.includes(":lambda:")?g.LambdaFunctionConfigurations=[{...h,LambdaFunctionArn:E}]:E.includes(":sqs:")?g.QueueConfigurations=[{...h,QueueArn:E}]:E.includes(":sns:")?g.TopicConfigurations=[{...h,TopicArn:E}]:g.TopicConfigurations=[{...h,TopicArn:E}];const K={...m,...g};g.LambdaFunctionConfigurations&&(K.LambdaFunctionConfigurations=[...m.LambdaFunctionConfigurations||[],...g.LambdaFunctionConfigurations]),g.QueueConfigurations&&(K.QueueConfigurations=[...m.QueueConfigurations||[],...g.QueueConfigurations]),g.TopicConfigurations&&(K.TopicConfigurations=[...m.TopicConfigurations||[],...g.TopicConfigurations]),await U($.bucketName,K),T.success(c("Create Success")),v.value=!1,_("success"),w()}catch(n){console.error("Failed to create bucket notification:",n),T.error(c("Create Failed"))}},d=()=>{v.value=!1,w()};return u({open:D}),(n,t)=>(N(),F(e(ce),{open:v.value,"onUpdate:open":W},{default:i(()=>[s(e(me),{class:"max-w-2xl",onPointerDownOutside:t[3]||(t[3]=z(()=>{},["prevent"])),onInteractOutside:t[4]||(t[4]=z(()=>{},["prevent"])),onEscapeKeyDown:t[5]||(t[5]=z(()=>{},["prevent"]))},{default:i(()=>[s(e(fe),{class:"text-left"},{default:i(()=>[s(e(de),null,{default:i(()=>[x(p(e(c)("Subscribe to event notification"))+" ",1),C("span",ke,p(`${e(c)("Bucket")}: ${Q.bucketName}`),1)]),_:1})]),_:1}),C("div",Re,[s(e(j),{orientation:"responsive",class:"sm:items-center"},{default:i(()=>[s(e(O),{for:"event-resource-name"},{default:i(()=>[x(p(e(c)("Amazon Resource Name")),1)]),_:1}),s(e(I),null,{default:i(()=>[s(e(be),{id:"event-resource-name",modelValue:l.value.resourceName,"onUpdate:modelValue":t[0]||(t[0]=o=>l.value.resourceName=o),disabled:!L.value.length},{default:i(()=>[s(e(ge),null,{default:i(()=>[s(e(xe),{placeholder:e(c)("Please select resource name")},null,8,["placeholder"])]),_:1}),s(e(ye),null,{default:i(()=>[(N(!0),J(Y,null,X(L.value,o=>(N(),F(e(Ce),{key:o.value,value:o.value},{default:i(()=>[x(p(o.label),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1}),b.resourceName?(N(),F(e(ee),{key:0,class:"text-destructive"},{default:i(()=>[x(p(b.resourceName),1)]),_:1})):q("",!0)]),_:1}),s(e(j),{orientation:"responsive",class:"sm:items-center"},{default:i(()=>[s(e(O),{for:"event-prefix"},{default:i(()=>[x(p(e(c)("Prefix")),1)]),_:1}),s(e(I),null,{default:i(()=>[s(e(Z),{id:"event-prefix",modelValue:l.value.prefix,"onUpdate:modelValue":t[1]||(t[1]=o=>l.value.prefix=o),placeholder:e(c)("Please enter prefix")},null,8,["modelValue","placeholder"])]),_:1})]),_:1}),s(e(j),{orientation:"responsive",class:"sm:items-center"},{default:i(()=>[s(e(O),{for:"event-suffix"},{default:i(()=>[x(p(e(c)("Suffix")),1)]),_:1}),s(e(I),null,{default:i(()=>[s(e(Z),{id:"event-suffix",modelValue:l.value.suffix,"onUpdate:modelValue":t[2]||(t[2]=o=>l.value.suffix=o),placeholder:e(c)("Please enter suffix")},null,8,["modelValue","placeholder"])]),_:1})]),_:1}),s(e(j),{orientation:"responsive"},{default:i(()=>[s(e(O),null,{default:i(()=>[x(p(e(c)("Select events")),1)]),_:1}),s(e(I),null,{default:i(()=>[s(e(he),{class:"max-h-64 rounded-md border"},{default:i(()=>[C("div",Se,[(N(),J(Y,null,X(M,o=>C("label",{key:o.value,class:"flex items-start gap-3"},[s(e(pe),{checked:l.value.events.includes(o.value),class:"mt-1","onUpdate:modelValue":m=>a(o.value,m)},null,8,["checked","onUpdate:modelValue"]),C("span",null,p(e(c)(o.labelKey)),1)])),64))])]),_:1})]),_:1}),b.events?(N(),F(e(ee),{key:0,class:"text-destructive"},{default:i(()=>[x(p(b.events),1)]),_:1})):q("",!0)]),_:1})]),C("div",Fe,[s(e(V),{type:"button",variant:"outline",onClick:d},{default:i(()=>[x(p(e(c)("Cancel")),1)]),_:1}),s(e(V),{type:"button",onClick:r},{default:i(()=>[x(p(e(c)("Save")),1)]),_:1})])]),_:1})]),_:1},8,["open"]))}}),Le=Object.assign(Te,{__name:"EventsNewForm"}),we={class:"text-2xl font-bold"},rt=te({__name:"index",setup(Q){const{t:u}=ae(),{listBucketNotifications:A,putBucketNotifications:B}=se({}),U=oe(),P=ne(),c={"s3:0bjectCreated:*":"PUT","s3:0bjectAccessed:*":"GET","s3:0bjectRemoved:*":"DELETE","s3:Replication:*":"REPLICA","s3:ObjectRestore:*":"RESTORE","s3:0bjectTransition:*":"RESTORE","s3:Scanner:ManyVersions":"SCANNER","s3:Scanner:BigPrefix":"SCANNER"},T=a=>[...new Set(a.map(f=>c[f]||f))],$={Lambda:"bg-amber-100 text-amber-900 dark:bg-amber-900/40 dark:text-amber-100",SQS:"bg-sky-100 text-sky-900 dark:bg-sky-900/40 dark:text-sky-100",SNS:"bg-emerald-100 text-emerald-900 dark:bg-emerald-900/40 dark:text-emerald-100",Topic:"bg-indigo-100 text-indigo-900 dark:bg-indigo-900/40 dark:text-indigo-100"},_=k(null),v=k(!1),l=k([]),b=[{id:"type",header:()=>u("Type"),cell:({row:a})=>y(H,{class:$[a.original.type]},()=>a.original.type),meta:{maxWidth:"7rem"}},{id:"arn",header:()=>u("ARN"),cell:({row:a})=>y("span",{class:"line-clamp-2 break-all font-medium"},a.original.arn),meta:{maxWidth:"180px"}},{id:"events",header:()=>u("Events"),cell:({row:a})=>y("div",{class:"flex flex-wrap gap-1"},T(a.original.events).map(f=>y(H,{variant:"secondary",key:f},()=>f))),meta:{maxWidth:"13rem"}},{id:"prefix",header:()=>u("Prefix"),cell:({row:a})=>y("span",a.original.prefix||"-"),meta:{maxWidth:"9rem"}},{id:"suffix",header:()=>u("Suffix"),cell:({row:a})=>y("span",a.original.suffix||"-"),meta:{maxWidth:"9rem"}},{id:"actions",header:()=>u("Actions"),enableSorting:!1,cell:({row:a})=>y("div",{class:"flex justify-center"},[y(V,{type:"button",size:"sm",variant:"outline",class:"gap-2",onClick:f=>L(a.original,f)},()=>[y(G,{class:"size-4",name:"ri:delete-bin-7-line"}),y("span",u("Delete"))])]),meta:{maxWidth:"6rem"}}],{table:M}=ve({data:l,columns:b,getRowId:a=>a.id});le(()=>_.value,async a=>{if(!a){l.value=[];return}await R()},{immediate:!0});const L=async(a,f)=>{if(f?.stopPropagation(),!!await new Promise(d=>{U.warning({title:u("Confirm Delete"),content:u("Are you sure you want to delete this notification configuration?"),positiveText:u("Delete"),negativeText:u("Cancel"),onPositiveClick:()=>d(!0),onNegativeClick:()=>d(!1)})}))try{if(v.value=!0,!_.value)return;const n=await A(_.value)||{};let t=[];a.type==="Lambda"&&n.LambdaFunctionConfigurations?t=n.LambdaFunctionConfigurations.filter(m=>m.Id!==a.id):a.type==="SQS"&&n.QueueConfigurations?t=n.QueueConfigurations.filter(m=>m.Id!==a.id):a.type==="SNS"&&n.TopicConfigurations&&(t=n.TopicConfigurations.filter(m=>m.Id!==a.id));const o={...n};a.type==="Lambda"?o.LambdaFunctionConfigurations=t:a.type==="SQS"?o.QueueConfigurations=t:a.type==="SNS"&&(o.TopicConfigurations=t),await B(_.value,o),P.success(u("Delete Success")),await R()}catch(d){console.error(u("Delete Failed"),d),P.error(`${u("Delete Failed")}: ${d.message||d}`)}finally{v.value=!1}},D=k(),W=()=>{D.value?.open()},w=async()=>{await R()},R=async()=>{if(v.value=!0,!_.value){l.value=[],v.value=!1;return}try{const a=await A(_.value),f=[];a.LambdaFunctionConfigurations&&a.LambdaFunctionConfigurations.forEach(r=>{const d=r.Filter?.Key?.FilterRules?.find(t=>t.Name==="Prefix")?.Value,n=r.Filter?.Key?.FilterRules?.find(t=>t.Name==="Suffix")?.Value;f.push({id:r.Id,type:"Lambda",arn:r.LambdaFunctionArn,events:r.Events||[],prefix:d,suffix:n,filterRules:r.Filter?.Key?.FilterRules||[]})}),a.QueueConfigurations&&a.QueueConfigurations.forEach(r=>{const d=r.Filter?.Key?.FilterRules?.find(t=>t.Name==="Prefix")?.Value,n=r.Filter?.Key?.FilterRules?.find(t=>t.Name==="Suffix")?.Value;f.push({id:r.Id,type:"SQS",arn:r.QueueArn,events:r.Events||[],prefix:d,suffix:n,filterRules:r.Filter?.Key?.FilterRules||[]})}),a.TopicConfigurations&&a.TopicConfigurations.forEach(r=>{const d=r.Filter?.Key?.FilterRules?.find(t=>t.Name==="Prefix")?.Value,n=r.Filter?.Key?.FilterRules?.find(t=>t.Name==="Suffix")?.Value;f.push({id:r.Id,type:"SNS",arn:r.TopicArn,events:r.Events||[],prefix:d,suffix:n,filterRules:r.Filter?.Key?.FilterRules||[]})}),l.value=f}catch(a){console.error(u("Get Notification Config Failed"),a),l.value=[]}finally{v.value=!1}};return(a,f)=>{const r=re,d=ue,n=Le,t=Ee;return N(),F(t,null,{default:i(()=>[s(d,null,{actions:i(()=>[s(r,{modelValue:_.value,"onUpdate:modelValue":f[0]||(f[0]=o=>_.value=o),placeholder:e(u)("Please select bucket"),"selector-class":"w-full","cache-key":"events-buckets"},null,8,["modelValue","placeholder"]),s(e(V),{type:"button",variant:"outline",onClick:W},{default:i(()=>[s(e(G),{class:"size-4",name:"ri:add-line"}),C("span",null,p(e(u)("Add Event Subscription")),1)]),_:1}),s(e(V),{type:"button",variant:"outline",onClick:w,disabled:v.value},{default:i(()=>[s(e(G),{class:"size-4",name:"ri:refresh-line"}),C("span",null,p(e(u)("Refresh")),1)]),_:1},8,["disabled"])]),default:i(()=>[C("h1",we,p(e(u)("Events")),1)]),_:1}),s(_e,{table:e(M),"is-loading":v.value,"empty-title":e(u)("No Data"),"empty-description":e(u)("Add Event Subscription to get started")},null,8,["table","is-loading","empty-title","empty-description"]),_.value?(N(),F(n,{key:0,ref_key:"newRef",ref:D,bucketName:_.value,onSuccess:R},null,8,["bucketName"])):q("",!0)]),_:1})}}});export{rt as default};
